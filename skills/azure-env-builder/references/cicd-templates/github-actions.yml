# GitHub Actions - Azure Bicep ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ Bicep ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ Azure ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
# ä½¿ç”¨æ–¹æ³•: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® .github/workflows/ ã«ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ç”¨
#
# å‰ææ¡ä»¶:
# 1. AZURE_CREDENTIALS ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ (JSONå½¢å¼ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«)
# 2. vars.RESOURCE_GROUP å¤‰æ•°
# 3. vars.AZURE_SUBSCRIPTION_ID å¤‰æ•° (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

name: Deploy Azure Environment

on:
  push:
    branches: [main]
    paths:
      - "env/**/bicep/**"
      - ".github/workflows/deploy-azure.yml"
  pull_request:
    branches: [main]
    paths:
      - "env/**/bicep/**"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod
      deploy_mode:
        description: "Deploy mode"
        required: true
        default: "validate"
        type: choice
        options:
          - validate
          - what-if
          - deploy

# åŒæ™‚å®Ÿè¡Œã‚’åˆ¶é™ï¼ˆç’°å¢ƒã”ã¨ã«1ã¤ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã®ã¿ï¼‰
concurrency:
  group: deploy-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

env:
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ï¼‰
  BICEP_PATH: env/${{ github.event.inputs.environment || 'dev' }}/bicep
  TEMPLATE_FILE: main.bicep
  PARAMETERS_FILE: parameters/${{ github.event.inputs.environment || 'dev' }}.json

jobs:
  # ========================================
  # 1. Bicep æ¤œè¨¼ã‚¸ãƒ§ãƒ–
  # ========================================
  validate:
    name: Validate Bicep
    runs-on: ubuntu-latest
    outputs:
      bicep_version: ${{ steps.bicep.outputs.version }}

    steps:
      # ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4

      # Azure CLI ãƒ­ã‚°ã‚¤ãƒ³
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Bicep CLI ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
      - name: Check Bicep version
        id: bicep
        run: |
          az bicep version
          echo "version=$(az bicep version --query 'value' -o tsv)" >> $GITHUB_OUTPUT

      # Bicep ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
      - name: Check template exists
        run: |
          if [ ! -f "${{ env.BICEP_PATH }}/${{ env.TEMPLATE_FILE }}" ]; then
            echo "::error::Template file not found: ${{ env.BICEP_PATH }}/${{ env.TEMPLATE_FILE }}"
            exit 1
          fi

      # Bicep Lint (æ§‹æ–‡ãƒã‚§ãƒƒã‚¯)
      - name: Lint Bicep template
        run: |
          az bicep build \
            --file ${{ env.BICEP_PATH }}/${{ env.TEMPLATE_FILE }} \
            --stdout > /dev/null

      # ARM ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼
      - name: Validate ARM template
        run: |
          az deployment group validate \
            --resource-group ${{ vars.RESOURCE_GROUP }} \
            --template-file ${{ env.BICEP_PATH }}/${{ env.TEMPLATE_FILE }} \
            --parameters @${{ env.BICEP_PATH }}/${{ env.PARAMETERS_FILE }}

  # ========================================
  # 2. What-If ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¸ãƒ§ãƒ–
  # ========================================
  what-if:
    name: What-If Preview
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event.inputs.deploy_mode == 'what-if'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # What-If å®Ÿè¡Œï¼ˆå¤‰æ›´å†…å®¹ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
      - name: Run What-If
        id: whatif
        run: |
          az deployment group what-if \
            --resource-group ${{ vars.RESOURCE_GROUP }} \
            --template-file ${{ env.BICEP_PATH }}/${{ env.TEMPLATE_FILE }} \
            --parameters @${{ env.BICEP_PATH }}/${{ env.PARAMETERS_FILE }} \
            --out table

      # PR ã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ  (PR ã®å ´åˆã®ã¿)
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `## ğŸ” What-If Preview

            **Environment:** \`${{ github.event.inputs.environment || 'dev' }}\`
            **Resource Group:** \`${{ vars.RESOURCE_GROUP }}\`

            What-If analysis completed. Check the job logs for detailed changes.

            <details>
            <summary>Deployment Info</summary>

            - Template: \`${{ env.BICEP_PATH }}/${{ env.TEMPLATE_FILE }}\`
            - Parameters: \`${{ env.BICEP_PATH }}/${{ env.PARAMETERS_FILE }}\`

            </details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # ========================================
  # 3. ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–
  # ========================================
  deploy:
    name: Deploy to Azure
    needs: validate
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event.inputs.deploy_mode == 'deploy'

    # ç’°å¢ƒã®ä¿è­·ãƒ«ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã“ã“ã§æŒ‡å®š
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
      url: https://portal.azure.com/#@/resource/subscriptions/${{ vars.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ vars.RESOURCE_GROUP }}/overview

    outputs:
      deployment_name: ${{ steps.deploy.outputs.deployment_name }}
      outputs: ${{ steps.deploy.outputs.outputs }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
      - name: Deploy Bicep template
        id: deploy
        run: |
          DEPLOYMENT_NAME="deploy-$(date +%Y%m%d-%H%M%S)"
          echo "deployment_name=$DEPLOYMENT_NAME" >> $GITHUB_OUTPUT

          # ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
          OUTPUTS=$(az deployment group create \
            --name $DEPLOYMENT_NAME \
            --resource-group ${{ vars.RESOURCE_GROUP }} \
            --template-file ${{ env.BICEP_PATH }}/${{ env.TEMPLATE_FILE }} \
            --parameters @${{ env.BICEP_PATH }}/${{ env.PARAMETERS_FILE }} \
            --query 'properties.outputs' \
            --output json)

          echo "outputs=$OUTPUTS" >> $GITHUB_OUTPUT

      # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚’ã‚µãƒãƒªãƒ¼ã«å‡ºåŠ›
      - name: Create deployment summary
        run: |
          echo "## âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment || 'dev' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ${{ vars.RESOURCE_GROUP }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment Name | ${{ steps.deploy.outputs.deployment_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Azure Portal](https://portal.azure.com/#@/resource/subscriptions/${{ vars.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ vars.RESOURCE_GROUP }}/overview)" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # 4. é€šçŸ¥ã‚¸ãƒ§ãƒ– (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
  # ========================================
  notify:
    name: Notify
    needs: [validate, deploy]
    runs-on: ubuntu-latest
    if: always() && needs.deploy.result != 'skipped'

    steps:
      # Slack é€šçŸ¥ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³ - ä½¿ç”¨ã™ã‚‹å ´åˆã¯ SLACK_WEBHOOK ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®š)
      - name: Notify Slack
        if: ${{ secrets.SLACK_WEBHOOK != '' }}
        run: |
          STATUS=${{ needs.deploy.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"Azure Deployment $STATUS\\nEnvironment: ${{ github.event.inputs.environment || 'dev' }}\\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
            ${{ secrets.SLACK_WEBHOOK }}

# ============================================================
# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †
# ============================================================
#
# 1. ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ä½œæˆ
#    az ad sp create-for-rbac --name "github-actions-sp" --role Contributor \
#      --scopes /subscriptions/{subscription-id}/resourceGroups/{resource-group} \
#      --sdk-auth
#
# 2. GitHub Secrets è¨­å®š
#    - AZURE_CREDENTIALS: ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã®å‡ºåŠ› JSON
#
# 3. GitHub Variables è¨­å®š
#    - RESOURCE_GROUP: å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—å
#    - AZURE_SUBSCRIPTION_ID: ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ ID
#
# 4. ç’°å¢ƒä¿è­·ãƒ«ãƒ¼ãƒ« (æ¨å¥¨)
#    Settings > Environments ã§ prod ç’°å¢ƒã«æ‰¿èªè€…ã‚’è¨­å®š
